<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Trello Reports – Connector</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <script>
    (function () {
      const ICON = { url: "https://cdn-icons-png.flaticon.com/512/1828/1828778.png" };
      // Abra a raiz (/) com os parâmetros — não use mais /index.html
      const BASE = "/";

      // Gera a URL com o boardId (pegando do contexto do Trello)
      async function buildUrl(t) {
        const ctx = await t.getContext();              // <- async é importante
        const boardId = ctx.board || "unknown";
        return `${BASE}?boardId=${boardId}&mode=public&access=devtoken`;
      }

      window.TrelloPowerUp.initialize(
        {
          // 🔘 Botão no topo
          "board-buttons": (t) => [
            {
              icon: ICON,
              text: "📊 Dashboard",
              condition: "always",
              callback: async () => {
                const url = await buildUrl(t);
                return t.modal({
                  title: "📊 Dashboard",
                  url: await t.signUrl(url),
                  fullscreen: true
                });
              }
            }
          ],

          // 📊 Visualização embutida (opcional)
          "board-views": (t) => [
            {
              url: async () => await t.signUrl(await buildUrl(t)),
              name: "📊 Dashboard",
              icon: ICON
            }
          ],

          // ⚙️ Configurações (opcional)
          "show-settings": async (t) => {
            const url = await buildUrl(t);
            return t.modal({
              title: "📊 Dashboard",
              url: await t.signUrl(url),
              fullscreen: true
            });
          }
        },
        { appName: "Trello Reports" } // se usar REST API, adicione appKey aqui
      );
    })();
  </script>
</body>
</html>
