<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <title>Trello Reports â€” Connector v2</title>

    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
      (function () {
        const ICON = { url: "https://cdn-icons-png.flaticon.com/512/1828/1828778.png" };
        const BASE = "https://trello-reports.vercel.app"; // RAIZ do app

        async function buildUrl(t) {
          const ctx = await t.getContext();
          const boardId = ctx.board || "unknown";
          const ts = Date.now(); // forÃ§a cache-buster
          const url = `${BASE}/?boardId=${boardId}&mode=public&access=devtoken&_=${ts}`;
          console.log("ðŸ”— URL gerada:", url);
          return url;
        }

        window.TrelloPowerUp.initialize(
          {
            "board-buttons": (t) => [
              {
                icon: ICON,
                text: "ðŸ“Š Dashboard",
                condition: "always",
                callback: async function (t) { // <- ASYNC Ã‰ OBRIGATÃ“RIO
                  const url = await buildUrl(t);
                  return t.modal({
                    title: "ðŸ“Š Dashboard",
                    url: await t.signUrl(url), // <- usa a URL final
                    fullscreen: true
                  });
                }
              }
            ],

            "board-views": (t) => [
              {
                url: async () => await t.signUrl(await buildUrl(t)),
                name: "ðŸ“Š Dashboard",
                icon: ICON
              }
            ],

            "show-settings": async (t) => {
              const url = await buildUrl(t);
              return t.modal({
                title: "ðŸ“Š Dashboard",
                url: await t.signUrl(url),
                fullscreen: true
              });
            }
          },
          { appName: "Trello Reports" }
        );
      })();
    </script>
  </head>
  <body></body>
</html>
