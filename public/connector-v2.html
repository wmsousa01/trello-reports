<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <title>Trello Reports ‚Äî Connector v2</title>

    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
      (function () {
        // √çcones inline para evitar falhas de carregamento
        const ICON = {
          dark: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><rect x="3" y="11" width="4" height="10"/><rect x="10" y="7" width="4" height="14"/><rect x="17" y="4" width="4" height="17"/></svg>',
          light: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black"><rect x="3" y="11" width="4" height="10"/><rect x="10" y="7" width="4" height="14"/><rect x="17" y="4" width="4" height="17"/></svg>'
        };

        const BASE = "https://trello-reports.vercel.app"; // RAIZ do app

        async function buildUrl(t) {
          const ctx = await t.getContext();
          const boardId = ctx.board || "unknown";
          const ts = Date.now(); // for√ßa cache-buster
          const url = `${BASE}/?boardId=${boardId}&mode=public&access=devtoken&_=${ts}`;
          console.log("üîó URL gerada:", url);
          return url;
        }

        window.TrelloPowerUp.initialize(
          {
            "board-buttons": (t) => [
              {
                icon: ICON,
                text: "üìä Dashboard",
                condition: "always",
                callback: async function (t) {
                  const url = await buildUrl(t);
                  return t.modal({
                    title: "üìä Dashboard",
                    url: await t.signUrl(url),
                    fullscreen: true
                  });
                }
              }
            ],

            "board-views": (t) => [
              {
                url: async () => await t.signUrl(await buildUrl(t)),
                name: "üìä Dashboard",
                icon: ICON
              }
            ],

            "show-settings": async (t) => {
              const url = await buildUrl(t);
              return t.modal({
                title: "üìä Dashboard",
                url: await t.signUrl(url),
                fullscreen: true
              });
            }
          },
          { appName: "Trello Reports" }
        );
      })();
    </script>
  </head>
  <body></body>
</html>